<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#333333">
  <title>기출 문제은행</title>
  <style>
    /* ====== 기본 레이아웃 ====== */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }

    header {
      background-color: #333;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .container {
      max-width: 960px;
      margin: 16px auto;
      padding: 16px;
      background: #fff;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      border-radius: 4px;
    }

    /* ====== 상단 제어 영역 ====== */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .subject-area { position: relative; }

    button {
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background-color: #fafafa;
    }
    button:hover { background-color: #eee; }

    .subject-dropdown {
      position: absolute;
      top: 36px;
      left: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 10;
      min-width: 160px;
    }

    .subject-dropdown button {
      display: block;
      width: 100%;
      text-align: left;
      border: none;
      border-bottom: 1px solid #eee;
      background: #fff;
    }

    .hidden { display: none; }
    .timer { font-weight: bold; }

    /* ====== 문제 영역 ====== */
    .question-area { margin-bottom: 16px; }
    .question-number { font-weight: bold; margin-bottom: 4px; }
    .options-area { margin-bottom: 12px; }
    .option-item { margin-bottom: 4px; }

    .result-box {
      min-height: 20px;
      margin-bottom: 12px;
      font-weight: bold;
    }
    .result-correct { color: #007700; }
    .result-wrong { color: #cc0000; }

    .nav-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    /* ====== 오답노트 영역 ====== */
    .wrong-note-area {
      margin-top: 16px;
      border-top: 1px solid #ddd;
      padding-top: 12px;
    }
    .wrong-note-item {
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 8px;
      background: #fafafa;
    }

    /* ====== 하단 푸터 ====== */
    .footer-bar {
      margin-top: 16px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
      color: #777;
    }

    .footer-left {
      font-size: 12px;
      line-height: 1.3;
      word-break: keep-all;
    }

    .footer-right {
      font-size: 9px;            /* “아주 작게” */
      color: #999;
      white-space: nowrap;
    }
   .subject-dropdown {
     max-height: 80vh;
     overflow-y: auto;
   }
    /* ====== 모바일 최적화 ====== */
    @media (max-width: 600px) {
        /* 전체 기본 글자 크기 */
        body { font-size: 16px; }

        /* 컨테이너: 폰에서는 화면 꽉 차게 */
        .container {
            max-width: none;
            margin: 0;
            border-radius: 0;
            padding: 14px;
        }

        /* 헤더 글자/패딩 */
        header {
            padding: 12px 14px;
        }
        header h1 {
            font-size: 18px;
            margin: 0;
        }
        .timer { font-size: 16px; }

        /* 버튼: 터치 타겟 키우기 */
        button {
            padding: 12px 14px;
            font-size: 16px;
        }

        /* 드롭다운: 화면을 더 잘 쓰게 */
        .subject-dropdown {
            min-width: 220px;
            max-height: 65vh;
        }
        .subject-dropdown button {
            padding: 12px 14px;
        }

        /* 보기 영역: 줄간격/터치 개선 */
        .option-item {
            display: inline-block;
            padding: 8px 0;
            font-size: 16px;
            line-height: 1.4;
        }
        input[type="radio"] {
            width: 18px;
            height: 18px;
            vertical-align: middle;
        }

        /* 네비 버튼: 폰에서는 2개가 화면 폭 절반씩 */
        .nav-buttons {
            gap: 10px;
        }
        .nav-buttons button {
            flex: 1;
        }

        /* 푸터 글자 크기 약간 상향 */
        .footer-left { font-size: 12px; }
        .footer-right { font-size: 10px; }
    }

  </style>
</head>

<body>
  <header>
    <h1>기출 문제은행</h1>
    <div class="timer" id="timer">00:00</div>
  </header>

  <div class="container">
    <!-- 상단 제어 영역 -->
    <div class="top-bar">
      <div class="subject-area">
        <button id="subjectToggleBtn">과목 선택</button>
        <div id="subjectDropdown" class="subject-dropdown hidden"></div>

        <span id="currentSubjectLabel" style="margin-left:8px;font-size:14px;color:#555;">
          과목이 선택되지 않았습니다.
        </span>
      </div>

      <div class="score-box">
        현재 점수: <span id="score">0</span> 점  
        (<span id="correctCount">0</span> / <span id="totalCount">0</span> 문제)
      </div>
    </div>

    <!-- 문제 영역 -->
    <div class="question-area">
      <div class="question-number" id="questionNumber"></div>
      <div class="question-text" id="questionText"></div>
      <div class="options-area" id="optionsArea"></div>

      <button id="checkAnswerBtn">정답 확인</button>
      <div class="result-box" id="resultBox"></div>
    </div>

    <div class="nav-buttons">
      <button id="prevBtn">이전 문제</button>
      <button id="nextBtn">다음 문제</button>
    </div>

    <div class="wrong-note-area">
      <button id="showWrongNoteBtn">오답노트 보기/숨기기</button>
      <div id="wrongNoteList" class="hidden"></div>
    </div>

    <!-- 하단 푸터 -->
    <div class="footer-bar">
      <div class="footer-left">해당 정답은 개인의 의견이므로 오류가 있을 수 있습니다.</div>
      <div class="footer-right">made by 20 손민수</div>
    </div>
  </div>

<script>
/* =========================
   외부 JSON 파일 설정
   ========================= */
const subjectFiles = {
  "수산생물의 양식": "data/A.json",
  "기생충성 질병": "data/B.json",
  "바이러스성 질병": "data/C.json",
  "세균성 질병": "data/D.json",
  "진균성 질병": "data/E.json",
  "비감염성 질병": "data/F.json",
  "생리학": "data/G.json",
  "병리학": "data/H.json",
  "면역학": "data/I.json",
  "약리학": "data/J.json",
  "수산법규 공중보건": "data/K.json",
  "20-25년도 기출문제": "data/2020-2025.json",
};

let questionBank = []; // JSON 파일에서 불러온 문제 배열

/* =========================
   상태 변수
   ========================= */
let currentSubject = null;
let currentIndex = 0;
let userAnswers = {};
let wrongNotes = [];
let timerSeconds = 0;
let timerId = null;

/* =========================
   타이머
   ========================= */
function startTimer() {
  if (timerId !== null) return;
  timerId = setInterval(() => {
    timerSeconds++;
    const min = String(Math.floor(timerSeconds / 60)).padStart(2, "0");
    const sec = String(timerSeconds % 60).padStart(2, "0");
    document.getElementById("timer").innerText = `${min}:${sec}`;
  }, 1000);
}

/* =========================
   과목 선택
   ========================= */
const subjectDropdown = document.getElementById("subjectDropdown");
const subjectToggleBtn = document.getElementById("subjectToggleBtn");
const currentSubjectLabel = document.getElementById("currentSubjectLabel");

subjectToggleBtn.addEventListener("click", () => {
  subjectDropdown.classList.toggle("hidden");
});

function buildSubjectDropdown() {
  subjectDropdown.innerHTML = "";
  Object.keys(subjectFiles).forEach(name => {
    const btn = document.createElement("button");
    btn.textContent = name;
    btn.addEventListener("click", () => {
      selectSubject(name);
      subjectDropdown.classList.add("hidden");
    });
    subjectDropdown.appendChild(btn);
  });
}
buildSubjectDropdown();
console.log("count", Object.keys(subjectFiles).length, Object.keys(subjectFiles));

/* =========================
   과목 선택 → JSON 로딩
   ========================= */
async function selectSubject(subjectName) {
  currentSubject = subjectName;
  currentIndex = 0;
  userAnswers = {};
  wrongNotes = [];
  timerSeconds = 0;
  clearInterval(timerId);
  timerId = null;

  startTimer();
  currentSubjectLabel.textContent = `현재 과목: ${subjectName}`;

  const filePath = subjectFiles[subjectName];

  try {
    const res = await fetch(filePath);
    if (!res.ok) throw new Error("JSON 파일 불러오기 오류");
    questionBank = await res.json();
    if (subjectName === "20-25년도 기출문제") {
      for (let i = questionBank.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [questionBank[i], questionBank[j]] = [questionBank[j], questionBank[i]];
      }
    }
  } catch (e) {
    console.error(e);
    questionBank = [];
  }

  renderQuestion();
  updateScore();
}

/* =========================
   문제 렌더링
   ========================= */
const questionNumberEl = document.getElementById("questionNumber");
const questionTextEl = document.getElementById("questionText");
const optionsAreaEl = document.getElementById("optionsArea");
const resultBoxEl = document.getElementById("resultBox");

function getCurrentQuestion() {
  if (questionBank.length === 0) return null;
  return questionBank[currentIndex];
}

function renderQuestion() {
  const q = getCurrentQuestion();

  document.getElementById("totalCount").textContent = questionBank.length;

  if (!q) {
    questionNumberEl.textContent = "";
    questionTextEl.textContent = "과목 또는 문제가 없습니다.";
    optionsAreaEl.innerHTML = "";
    return;
  }

  resultBoxEl.textContent = "";
  resultBoxEl.className = "result-box";

  questionNumberEl.textContent = `${currentIndex + 1}번 문제`;
  questionTextEl.textContent = q.question;

  optionsAreaEl.innerHTML = "";

  q.options.forEach((opt, idx) => {
    const label = document.createElement("label");
    label.className = "option-item";

    const input = document.createElement("input");
    input.type = "radio";
    input.name = "answer";
    input.value = idx;

    const key = `${currentSubject}-${q.id}`;
    if (userAnswers[key] === idx) input.checked = true;

    label.appendChild(input);
    label.append(` ${idx + 1}. ${opt}`);
    optionsAreaEl.appendChild(label);
    optionsAreaEl.appendChild(document.createElement("br"));
  });
}

/* =========================
   정답 확인 & 오답노트
   ========================= */
document.getElementById("checkAnswerBtn").addEventListener("click", () => {
  const q = getCurrentQuestion();
  if (!q) return;

  const selected = document.querySelector('input[name="answer"]:checked');
  if (!selected) {
    resultBoxEl.textContent = "보기를 선택하세요.";
    return;
  }

  const selectedIndex = parseInt(selected.value);
  const key = `${currentSubject}-${q.id}`;
  userAnswers[key] = selectedIndex;

if (selectedIndex + 1 === q.answer) {
    resultBoxEl.textContent = "정답입니다.";
    resultBoxEl.classList.add("result-correct");
  } else {
    resultBoxEl.textContent = `오답입니다. 정답은 ${q.answer}번입니다.`;
    resultBoxEl.classList.add("result-wrong");

    if (!wrongNotes.find(item => item.id === q.id && item.subject === currentSubject)) {
      wrongNotes.push({
        subject: currentSubject,
        id: q.id,
        question: q.question,
        options: q.options,
        correct: q.answer,
        user: selectedIndex
      });
    }
  }

  updateScore();
});

/* =========================
   점수 계산
   ========================= */
function updateScore() {
  let correctCount = 0;

  questionBank.forEach(q => {
    const key = `${currentSubject}-${q.id}`;
    if (userAnswers[key] + 1 === q.answer) correctCount++;
  });

  const total = questionBank.length;
  const score = total ? Math.round((correctCount / total) * 100) : 0;

  document.getElementById("score").textContent = score;
  document.getElementById("correctCount").textContent = correctCount;
}

/* =========================
   이전/다음 문제
   ========================= */
document.getElementById("prevBtn").addEventListener("click", () => {
  if (currentIndex > 0) {
    currentIndex--;
    renderQuestion();
  }
});

document.getElementById("nextBtn").addEventListener("click", () => {
  if (currentIndex < questionBank.length - 1) {
    currentIndex++;
    renderQuestion();
  }
});

/* =========================
   오답노트
   ========================= */
document.getElementById("showWrongNoteBtn").addEventListener("click", () => {
  const box = document.getElementById("wrongNoteList");
  box.classList.toggle("hidden");

  if (!box.classList.contains("hidden")) {
    renderWrongNotes();
  }
});

function renderWrongNotes() {
  const box = document.getElementById("wrongNoteList");
  box.innerHTML = "";

  if (wrongNotes.length === 0) {
    box.textContent = "오답노트가 비어 있습니다.";
    return;
  }

  wrongNotes.forEach(item => {
    const div = document.createElement("div");
    div.className = "wrong-note-item";

    div.innerHTML = `
      <strong>[${item.subject}] ${item.id}번</strong><br>
      ${item.question}<br>
      ${item.options.map((v, i) => `${i+1}. ${v}`).join("<br>")}
      <br><small>내 답: ${item.user + 1}번 / 정답: ${item.correct}번</small>
    `;
    box.appendChild(div);
  });
}
/* =========================
   키보드 단축키
   - 1~6: 보기 선택 (상단 숫자키 + 키패드)
   - Enter: 정답 확인
   - Space: 다음 문제
   ========================= */

function isTypingInInput(target) {
  if (!target) return false;
  const tag = (target.tagName || "").toUpperCase();
  return tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT" || target.isContentEditable;
}

function selectOptionByNumber(n) {
  const q = getCurrentQuestion();
  if (!q) return;

  // 보기 개수보다 크면 무시
  if (!Array.isArray(q.options) || n < 1 || n > q.options.length) return;

  const radios = document.querySelectorAll('input[name="answer"]');
  const idx = n - 1;
  if (!radios || !radios[idx]) return;

  radios[idx].checked = true;
}

document.addEventListener("keydown", (e) => {
  if (!currentSubject || questionBank.length === 0) return;
  if (isTypingInInput(e.target)) return;

  // 1~6 (상단 숫자키)
  if (e.key >= "1" && e.key <= "6") {
    e.preventDefault();
    selectOptionByNumber(parseInt(e.key, 10));
    return;
  }

  // 1~6 (키패드)
  if (e.code && /^Numpad[1-6]$/.test(e.code)) {
    e.preventDefault();
    const n = parseInt(e.code.replace("Numpad", ""), 10);
    selectOptionByNumber(n);
    return;
  }

  // Enter: 정답 확인
  if (e.key === "Enter" || e.code === "Enter") {
    e.preventDefault();
    const btn = document.getElementById("checkAnswerBtn");
    if (btn) btn.click();
    return;
  }

  // Space: 다음 문제 (브라우저별 차이 보강)
  if (e.code === "Space" || e.key === " " || e.key === "Spacebar") {
    e.preventDefault();
    const btn = document.getElementById("nextBtn");
    if (btn) btn.click();
    return;
  }
});
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js");
  });
}
</script>

</body>
</html>
